---

layout: post
title: "MongoDB - как убедиться что мы обновляем то, что прочитали?"
published: true
permalink: mongodb-write-your-own-reads
#category: ['work', 'code']
date: 2011-12-17

---

Иногда бывает необходимо убедиться что обновляемый документ не был изменён кем-то ещё после того как мы его прочитали. В мире реляционных баз данных для этого можно было бы применить транзакции, хотя они тоже не лучшее решение. Но в MongoDB нет даже транзакций. Как бы в такой ситуации?

Рассмотрим типичный use-case - редактирование документа через веб-форму. 
После того как мы прочитали документ и начали его редактировать и до момента сохранения может пройти много времени. И нам нужно убедиться что, когда мы будет сохранять документ, в базе будет именно та версия которую мы начали редактировать. После того как мы убедились что документ не редактировался никем кроме нас, мы можем его спокойно сохранить.

Транзакции в данном случае тоже не выход из ситуации, т.к. время редактирования документа может быть большим, скажем десятки минут, и держать транзакцию открытой всё это время может быть довольно затратно.

## Версионирование документов

Для решение этой проблемы в MongoDB можно использовать атомарные обновления и поле с версией документа.
Версия - это числовое, инкрементное поле в документе. При создании документа мы пишем в версию начальное значение, скажем 0, а при редактировании увеличиваем его на единицу.

<pre class="brush:js">
{
	_id: ObjectId(...),
	version: 0,
	title: "Какие-то поля документа",
	…
}
</pre>

При чтении документа и отображении его в форме мы запоминаем текущую версию и при обновлении указываем её в условии:

<pre class="brush:js">
db.blog.update(
  {'_id': ObjectId(...), 'version': 0}, // Обновляем документ по _id и версии которую мы ожидаем
  {'$set': new_data, '$inc': { 'version': 1 }}, // Обновляем данные и увеличиваем версию
  safe=True // Нам нужно получить результат обновления (getLastError)
)
</pre>

В ответе сервера нас интересует поле *n*:
<pre class="brush:js">
{'updatedExisting': True, …, 'ok': 1.0, 'err': None, 'n': 1}
</pre>

Если n = 1, значит всё прошло удачно и мы обновили наш документ, если 0 - значит документа с нужной нам версией уже нет и нужно что-то с этим делать. Вариантов тут несколько:

* Снова показать пользователю форму редактирования с сообщением что данные успели измениться, и показать какие данные в базе сейчас.
* Попытаться определить отличия самостоятельно и или разрешить конфликт автоматом или показать пользователю только конфликтные поля.
* Или в зависимости от специфики приложения предложить ещё варианты. 

Это всё позволяет нам быть уверенным в том что мы обновляем именно те данные что мы и ожидаем.